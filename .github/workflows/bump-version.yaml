# DO NOT EDIT THIS FILE.
# Instead, edit the jsonpatch file (actually YAML) in .github/bump-version-patch.yaml
# For docs, see github-actions in the IronCoreLabs/depot repo.

name: Bump Version
'on':
  push:
    branches:
    - main
  workflow_dispatch:
    inputs:
      version:
        description: New semver release version.
        required: true
env:
  COMMIT_PREFIX: 'bump-version: '
jobs:
  vars:
    runs-on: ubuntu-20.04
    outputs:
      commit-prefix: ${{ steps.echo.outputs.commit-prefix }}
    steps:
    - id: echo
      run: echo "::set-output name=commit-prefix::${{ env.COMMIT_PREFIX }}"
  bump:
    needs:
    - vars
    runs-on: ubuntu-20.04
    if: '!contains(join(github.event.commits.*.message), needs.vars.outputs.commit-prefix)'
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.WORKFLOW_PAT }}
    - name: Configure git
      run: 'git config --global user.email ops@ironcorelabs.com

        git config --global user.name "Leeroy Travis"

        '
    - name: Compute version
      id: versions
      run: "set -x\n# Read the current prerelease version.\nVERSION=$(.github/bump-version.sh)\n\
        echo \"::set-output name=old::${VERSION}\"\nBUILDNUM=$(echo \"${VERSION}\"\
        \ | sed 's/[^0-9][^0-9]*/ /g' | awk '{print $NF}')\nif [ \"${BUILDNUM}\" =\
        \ \"\" ] ; then\n  BUILDNUM=0\nfi\n\n# Set the release version. If this is\
        \ a workflow_dispatch, use the specified version. Otherwise increment the\
        \ \"-pre.N\" part.\nif [ -n \"${{ github.event.inputs.version }}\" ] ; then\n\
        \  VERSION=\"${{ github.event.inputs.version }}\"\nelse\n  BUILDNUM=$(expr\
        \ \"${BUILDNUM}\" + 1)\n  VERSION=\"$(echo \"${VERSION}\" | sed 's/-.*//')\"\
        \n  VERSION=\"${VERSION}-pre.${BUILDNUM}\"\nfi\necho \"::set-output name=release::${VERSION}\"\
        \n\n# Is it a release version? If so, it won't have a '-' character in it.\
        \ \"1.2.3-pre.4\" is not a release version.\nif [[ ${VERSION} =~ .*-.* ]]\
        \ ; then\n  echo \"::set-output name=is_release::false\"\nelse\n  echo \"\
        ::set-output name=is_release::true\"\n  VERSION=\"$(echo \"${VERSION}\" |\
        \ awk -F. -v OFS=. '{$NF += 1 ; print}')-pre.1\"\n  echo \"::set-output name=bumped::${VERSION}\"\
        \nfi\n"
    - name: Set release version
      run: '.github/bump-version.sh "${{ steps.versions.outputs.release }}"

        git diff --cached

        '
    - name: Commit release
      run: 'git commit -m "${COMMIT_PREFIX}Set release version ${{ steps.versions.outputs.release
        }}"

        '
    - name: Tag release
      run: 'git tag "${{ steps.versions.outputs.release }}"

        '
    - name: Push release tag
      run: 'git push origin "${{ github.ref }}"

        git push origin "${{ steps.versions.outputs.release }}"

        '
    - name: Create prerelease
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.WORKFLOW_PAT }}
        prerelease: true
        tag: ${{ steps.versions.outputs.release }}
    - name: Bump version and set pre-release
      run: '.github/bump-version.sh "${{ steps.versions.outputs.bumped }}"

        git diff --cached

        '
      if: ${{ steps.versions.outputs.bumped != '' }}
    - name: Commit and push pre-release version
      run: 'git commit -m "${COMMIT_PREFIX}Bump to next pre-release version ${{ steps.versions.outputs.bumped
        }}"

        git push origin main

        '
      if: ${{ steps.versions.outputs.bumped != '' }}
